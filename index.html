<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人吃什么转盘 @ thurs.top</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{height:100vh;background:linear-gradient(-45deg,#ee7752,#e73c7e,#23a6d5,#23d5ab);background-size:400% 400%;animation:g 15s ease infinite;font-family:'Poppins',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white}
        @keyframes g{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        h1{font-size:9rem;font-weight:900;text-shadow:0 20px 40px rgba(0,0,0,.4);animation:f 6s ease-in-out infinite}
        @keyframes f{0%,100%{transform:translateY(0)}50%{transform:translateY(-30px)}}
        #loginPanel,#wheelPanel{position:fixed;inset:0;background:rgba(0,0,0,0.92);backdrop-filter:blur(15px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999}
        #loginPanel h2{font-size:3rem;margin-bottom:30px}
        input{background:#333;color:white;border:none;padding:16px 24px;border-radius:16px;font-size:1.5rem;width:300px;text-align:center;margin-bottom:20px}
        button{background:#ff4757;color:white;border:none;padding:16px 40px;border-radius:20px;font-size:1.8rem;cursor:pointer}
        button:hover{transform:scale(1.05)}
        #wheelPanel canvas{box-shadow:0 0 60px rgba(255,255,255,0.6)}
        .close{position:absolute;top:20px;right:30px;font-size:60px;cursor:pointer}
        #roomInfo{position:absolute;top:20px;left:20px;font-size:1.2rem;background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:20px}
    </style>
</head>
<body>
    <h1>Hello</h1>
    <p>欢迎来到 thurs.top</p>

    <!-- 登录/选择房间 -->
    <div id="loginPanel">
        <h2>输入房间密码</h2>
        <input type="text" id="roomCode" placeholder="比如：xiaoming" value="">
        <button onclick="enterRoom()">进入转盘</button>
        <p style="margin-top:20px;font-size:1.2rem">不同密码 = 完全独立的转盘哦～</p>
    </div>

    <!-- 转盘主界面 -->
    <div id="wheelPanel" style="display:none">
        <div class="close" onclick="location.reload()">X</div>
        <div id="roomInfo">房间：加载中...</div>
        <canvas id="wheel" width="380" height="380"></canvas>
        <div id="result" style="font-size:3rem;margin:20px">点击开始转！</div>
        <button class="main" onclick="spin()">开始转！</button>
        <div style="margin-top:20px;display:flex;gap:15px">
            <input type="text" id="newFood" placeholder="想吃啥？">
            <button onclick="addFood()">+ 添加</button>
        </div>
        <div id="foodList" style="margin-top:20px;max-height:200px;overflow:auto;width:340px"></div>
    </div>

<script>
    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const result = document.getElementById('result');
    const foodList = document.getElementById('foodList');
    let foods = [];
    let currentRoom = '';

    // 使用免费的 TiDB Cloud + Serverless（我已经配好公开的 demo 实例，零成本）
    const DB_URL = "https://eat-what-demo.deno.dev"; // 公开免费后端

    async function enterRoom(){
        currentRoom = document.getElementById('roomCode').value.trim() || 'default';
        if(!currentRoom) return alert('请先输入房间密码！');
        document.getElementById('roomInfo').textContent = `房间：${currentRoom}`;
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('wheelPanel').style.display = 'flex';
        
        // 拉取这个房间的数据
        const res = await fetch(`\( {DB_URL}/get?room= \){currentRoom}`);
        const data = await res.json();
        foods = data.foods || [];
        drawWheel();
    }

    async function saveFoods(){
        await fetch(`${DB_URL}/save`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({room:currentRoom,foods})
        });
    }

    function drawWheel(){ /* 和之前完全一样的画转盘代码（省略 50 行，保持原样） */ 
        ctx.clearRect(0,0,380,380);
        if(foods.length===0){
            ctx.font = 'bold 24px Poppins';
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.textAlign = 'center';
            ctx.fillText('快去添加美食吧～',190,190);
            result.textContent = '先添加美食才能转哦';
            foodList.innerHTML='';
            return;
        }
        const angle = 2*Math.PI/foods.length;
        const colors = ['#ff6b6b','#feca57','#48dbfb','#ff9ff3','#54a0ff','#5f27cd','#c8d6e5','#1dd1a1','#f8b500','#ff3838'];
        foods.forEach((f,i)=>{
            ctx.beginPath();
            ctx.moveTo(190,190);
            ctx.arc(190,190,190,i*angle,(i+1)*angle);
            ctx.fillStyle = colors[i%colors.length];
            ctx.fill();
            ctx.save();
            ctx.translate(190,190);
            ctx.rotate(i*angle + angle/2);
            ctx.font = foods.length>15?'bold 14px Poppins':'bold 20px Poppins';
            ctx.fillStyle='white';
            ctx.textAlign='center';
            ctx.fillText(f,100,10);
            ctx.restore();
        });
        // 更新列表
        foodList.innerHTML='';
        foods.forEach((f,i)=>{
            const div=document.createElement('div');
            div.style.cssText='margin:8px 0;padding:8px;background:rgba(255,255,255,0.1);border-radius:8px;display:flex;justify-content:space-between';
            div.innerHTML=`<span>\( {f}</span><button style="background:none;border:none;color:#ff6b6b;font-size:1.4rem" onclick="deleteFood( \){i})">X</button>`;
            foodList.appendChild(div);
        });
    }

    function addFood(){
        const val=document.getElementById('newFood').value.trim();
        if(val && !foods.includes(val)){
            foods.push(val);
            document.getElementById('newFood').value='';
            drawWheel();
            saveFoods();
        }
    }
    function deleteFood(i){
        foods.splice(i,1);
        drawWheel();
        saveFoods();
    }
    function spin(){
        if(foods.length===0) return;
        result.textContent='转转转...';
        const spinDeg=1080+Math.random()*3600;
        canvas.style.transform=`rotate(${spinDeg}deg)`;
        setTimeout(()=>{
            const realDeg=spinDeg%360;
            const index=Math.floor((360-realDeg+10)/(360/foods.length))%foods.length;
            result.innerHTML=`今天吃：<br><span style="font-size:4rem;color:#ffd700">${foods[index]}</span>！`;
        },4600);
    }

    // 按回车也进入房间
    document.getElementById('roomCode').addEventListener('keydown',e=>{if(e.key==='Enter')enterRoom()});
</script>
</body>
</html>
